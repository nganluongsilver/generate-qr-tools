<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tool t·∫°o QR Thanh To√°n Nhanh | Ng√¢n L∆∞·ª£ng Silver</title>
  <link rel="icon" type="image/x-icon" href="https://www.nganluongsilver.com/favicon.ico">
 <style>
  :root {
    --bg: #f9fafb; --card: #ffffff; --muted: #475569; --text: #0f172a; --accent: #2563eb; --ring:#e2e8f0;
  }
  * { box-sizing: border-box; }
  body {
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg);
    color: var(--text);
    font-size: 16px; /* ƒë·∫£m b·∫£o font base ƒë·ªß l·ªõn */
  }
  .container { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
  .grid { display: grid; grid-template-columns: 1.4fr 1fr; gap: 20px; }
  .card {
    background: var(--card);
    border: 1px solid var(--ring);
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  }
  h1 { font-size: 20px; margin: 0 0 10px; letter-spacing: .2px; }
  p { color: var(--muted); margin: 0 0 16px; }
  label { display:block; font-size: 14px; color: var(--muted); margin-bottom: 6px; }
  
  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--ring);
    background: #fff;
    color: var(--text);
    outline: none;
    font-size: 16px; /* üëà fix auto zoom iOS */
    line-height: 1.4;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37,99,235,.25);
  }
  
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  
  .btns { display:flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
  button, .btn {
    cursor:pointer;
    border:1px solid var(--ring);
    background:#f1f5f9;
    color:var(--text);
    padding:10px 16px;
    border-radius:10px;
    font-size: 16px; /* ƒë·ªìng b·ªô k√≠ch th∆∞·ªõc */
  }
  .btn.primary {
    background: linear-gradient(135deg, #2563eb, #06b6d4);
    color:#fff;
    border: none;
  }
  
  code {
    background:#f1f5f9;
    border:1px solid var(--ring);
    padding:8px 10px;
    border-radius:8px;
    display:block;
    word-break: break-all;
    color: #334155;
  }
  
  .qr-wrap { text-align:center; }
  .qr-wrap img { width: 100%; max-width: 360px; border-radius: 12px; background: #fff; }
  .kinfo { text-align:center; font-size:14px; color: var(--muted); margin-top: 10px; }
  .helper { font-size:13px; color: var(--muted); margin-top:6px }
  footer { margin-top: 22px; text-align:center; color: var(--muted); font-size:13px }
  
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
</style>

</head>
<body>
  <div class="container">
    <h1>Tool t·∫°o ·∫£nh QR chuy·ªÉn kho·∫£n | Ng√¢n L∆∞·ª£ng Silver</h1>
    <div class="grid">
      <!-- Form -->
      <div class="card">
        <div class="row">
          <div>
            <label>S·ªë t√†i kho·∫£n (b·∫Øt bu·ªôc)</label>
            <input id="acc" value="1055513930" placeholder="VD: 1055513930" />
          </div>
          <div>
            <label>Ng√¢n h√†ng (b·∫Øt bu·ªôc)</label>
            <select id="bank"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>S·ªë ti·ªÅn (t√πy ch·ªçn) ‚Äî c√≥ th·ªÉ ƒë·ªÉ tr·ªëng. Upload PDF s·∫Ω t·ª± ƒëi·ªÅn n·∫øu t√¨m th·∫•y "C√≤n ph·∫£i thu"</label>
            <input id="amount" type="text" placeholder="VD: 1000000" />
          </div>
          <div>
            <label>Template</label>
            <select id="template">
              <option value="">(m·∫∑c ƒë·ªãnh)</option>
              <option value="compact">compact</option>
              <option value="qronly">qronly</option>
            </select>
          </div>
        </div>
        <div>
          <label>N·ªôi dung chuy·ªÉn kho·∫£n</label>
          <select id="desSelect">
            <option value="Ngan Luong Silver - 0763600889 - ck mua bac" selected>Ngan Luong Silver - 0763600889 - ck mua bac</option>
            <option value="Ngan Luong Future - 0777584279 - ck mua bac">Ngan Luong Future - 0777584279 - ck mua bac</option>
            <option value="other">Kh√°c (t·ª± nh·∫≠p)</option>
          </select>
          <input id="des" placeholder="Nh·∫≠p n·ªôi dung kh√°c..." style="margin-top:6px; display:none" />
        </div>

        <div style="margin-top:12px">
          <label>Upload ho√° ƒë∆°n PDF (t·ª± tr√≠ch s·ªë ·ªü m·ª•c "C√≤n ph·∫£i thu")</label>
          <input id="pdfFile" type="file" accept="application/pdf" />
          <div class="helper" id="pdfMsg">Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n.</div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>T√™n ch·ªß TK (hi·ªÉn th·ªã ph·ª•, kh√¥ng g·ª≠i l√™n link)</label>
            <input id="accName" value="CTCP KIM LOAI QUY ANCARAT" />
          </div>
        </div>

        <div class="btns">
          <button class="btn primary" id="btnCopy">Copy link QR</button>
          <a class="btn" id="btnSave" download>T·∫£i ·∫£nh v·ªÅ</a>
        </div>

        <div style="margin-top:14px">
          <label>Link ·∫£nh QR t·∫°o ra</label>
          <code id="outUrl"></code>
          <div class="helper">L∆∞u √Ω: Tham s·ªë <b>bank</b> nh·∫≠n m√£ ng√¢n h√†ng (code). Ch·ªâ <b>acc</b> v√† <b>bank</b> l√† b·∫Øt bu·ªôc.</div>
          <div id="error" style="color:#b91c1c; margin-top:8px; font-size:13px;"></div>
        </div>
      </div>

      <!-- Preview -->
      <div class="card qr-wrap">
        <img id="qrImg" alt="QR s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y" />
        <div class="kinfo" id="accLabel"></div>
      </div>
    </div>
  </div>

  <!-- PDF.js t·ª´ CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    if(window['pdfjsLib']){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }

    const $ = id => document.getElementById(id);
    const errorEl = $('error');
    const pdfMsg = $('pdfMsg');

    async function loadBanks(){
      try{
        const res = await fetch('https://qr.sepay.vn/banks.json');
        const data = await res.json();
        const bankSel = $('bank');
        data.data.forEach(b=>{
          const opt = document.createElement('option');
          opt.value = b.code;
          opt.textContent = `${b.code} - ${b.short_name}`;
          if(b.code === 'VCB') opt.selected = true;
          bankSel.appendChild(opt);
        });
      }catch(e){
        console.error('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch bank', e);
      }
    }

    function extractAmountFromText(text){
      const patterns = [
        /C[o√≤√≥·ªè√µ·ªçO√í√ì·ªé√ï·ªå]n\s+p[hh]·∫£i\s+thu\s*[:\-‚Äì‚Äî]?\s*([\d.,]+)/i,
        /C√≤n\s+ph·∫£i\s+thu\s*[:\-‚Äì‚Äî]?\s*([\d.,]+)/i,
        /Con\s+phai\s+thu\s*[:\-‚Äì‚Äî]?\s*([\d.,]+)/i
      ];
      for(const re of patterns){
        const m = text.match(re);
        if(m && m[1]){
          const raw = m[1].replace(/[.,]/g, '');
          if(/^[0-9]+$/.test(raw)) return raw;
        }
      }
      return null;
    }

    async function parsePdfFile(file){
      errorEl.textContent = '';
      pdfMsg.textContent = 'ƒêang ƒë·ªçc file...';
      try{
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let fullText = '';
        for(let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(it => it.str);
          fullText += strings.join(' ') + '\n';
        }
        pdfMsg.textContent = 'ƒê√£ ƒë·ªçc xong. ƒêang t√¨m "C√≤n ph·∫£i thu"...';
        const amount = extractAmountFromText(fullText);
        if(amount){
          $('amount').value = amount;
          pdfMsg.textContent = `T√¨m th·∫•y "C√≤n ph·∫£i thu": ${amount} ‚Äî ƒë√£ ƒëi·ªÅn v√†o √¥ S·ªë ti·ªÅn.`;
          errorEl.textContent = '';
          refresh();
        } else {
          pdfMsg.textContent = 'Kh√¥ng t√¨m th·∫•y m·ª•c "C√≤n ph·∫£i thu" trong file.';
          errorEl.textContent = 'L·ªói: kh√¥ng t√¨m th·∫•y s·ªë "C√≤n ph·∫£i thu" trong PDF.';
        }
      } catch(err){
        console.error(err);
        pdfMsg.textContent = 'ƒê·ªçc file th·∫•t b·∫°i.';
        errorEl.textContent = 'L·ªói khi ƒë·ªçc PDF: ' + (err && err.message ? err.message : String(err));
      }
    }

    $('pdfFile').addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f){ pdfMsg.textContent = 'Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n.'; return; }
      if(f.type !== 'application/pdf' && !f.name.toLowerCase().endsWith('.pdf')){
        pdfMsg.textContent = 'Vui l√≤ng ch·ªçn file PDF.';
        errorEl.textContent = 'L·ªói: file kh√¥ng ph·∫£i PDF.';
        return;
      }
      parsePdfFile(f);
    });

    function buildURL(){
      const base = 'https://qr.sepay.vn/img';
      const acc = $('acc').value.trim();
      const bank = $('bank').value.trim();
      const amount = $('amount').value.trim();
      const des = $('desSelect').value === 'other' ? $('des').value.trim() : $('desSelect').value.trim();
      const template = $('template').value;

      if(!acc || !bank){
        return '';
      }
      const params = new URLSearchParams();
      params.set('acc', acc);
      params.set('bank', bank);
      if(amount) params.set('amount', amount);
      if(des) params.set('des', des);
      if(template) params.set('template', template);
      return base + '?' + params.toString();
    }

    function refresh(){
      const url = buildURL();
      const out = $('outUrl');
      const img = $('qrImg');
      const save = $('btnSave');

      out.textContent = url || '‚Äî thi·∫øu acc/bank ‚Äî';
      if(url){
        img.src = url;
        img.style.opacity = 1;
        save.href = url;
        // ƒê·∫∑t t√™n file t·∫£i v·ªÅ
        const bank = $('bank').value.trim();
        const acc = $('acc').value.trim();
        const amount = $('amount').value.trim();
        const today = new Date().toISOString().slice(0,10);
        let filename = `QR_${bank}_${acc}`;
        if(amount) filename += `_${amount}`;
        filename += `_${today}.png`;
        save.download = filename;
        errorEl.textContent = '';
      } else {
        img.removeAttribute('src');
        img.style.opacity = .5;
        save.removeAttribute('href');
        save.removeAttribute('download');
      }
      const name = $('accName').value.trim();
      const accVal = $('acc').value.trim();
      $('accLabel').textContent = accVal ? `${name ? name + ' ‚Ä¢ ' : ''}${accVal}` : '';
    }

    ['acc','bank','amount','template','accName','des','desSelect'].forEach(id => {
      $(id).addEventListener('input', refresh);
      $(id).addEventListener('change', refresh);
    });

    $('desSelect').addEventListener('change', ()=>{
      if($('desSelect').value === 'other'){
        $('des').style.display = 'block';
      } else {
        $('des').style.display = 'none';
        $('des').value = $('desSelect').value;
      }
      refresh();
    });

    $('btnCopy').addEventListener('click', async function(){
      const url = $('outUrl').textContent.trim();
      if(!url || url.startsWith('‚Äî')) return alert('Thi·∫øu acc/bank ƒë·ªÉ t·∫°o link.');
      try {
        await navigator.clipboard.writeText(url);
        this.textContent = 'ƒê√£ copy ‚úî';
        setTimeout(()=> this.textContent = 'Copy link QR', 1500);
      } catch(err){
        alert('Kh√¥ng copy ƒë∆∞·ª£c. H√£y b√¥i ƒëen link v√† copy th·ªß c√¥ng.');
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      loadBanks();
      refresh();
    });
  </script>
</body>
</html>
